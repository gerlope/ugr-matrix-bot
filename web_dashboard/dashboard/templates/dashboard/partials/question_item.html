{% comment %} Single question item used inside questions_panel {% endcomment %}
<li x-data="{ open: false }" x-init="open = __lsGet('q_open_{{ q.id }}') === 'true'" data-question-id="{{ q.id }}" class="py-2 hover:bg-gray-50 rounded transition cursor-pointer" @click="open = !open; __lsSet('q_open_{{ q.id }}', open ? 'true' : 'false')" tabindex="0" @keydown.enter.prevent="open = !open; __lsSet('q_open_{{ q.id }}', open ? 'true' : 'false')" @keydown.space.prevent="open = !open; __lsSet('q_open_{{ q.id }}', open ? 'true' : 'false')">
  <div class="w-full text-left">
    <div class="w-full flex justify-between items-center text-left px-2 py-2">
      <div>
        <div class="font-semibold">{{ q.title|default:"(sin título)" }}</div>
        <div class="text-gray-700 text-sm mt-1">{{ q.body }}</div>
        <div class="text-xs text-gray-500 mt-1">Tipo: {{ q.qtype }} · Creada: {{ q.created_at|date:"Y-m-d H:i" }}</div>
      </div>
      <div class="text-right text-sm text-gray-600">
        {% if q.manual_active %}
          <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Manual</span>
        {% endif %}
        {% if active_now %}
          <div class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded">Activo</div>
        {% else %}
          <div class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded">Inactivo</div>
        {% endif %}
        {% if q.close_on_first_correct %}
          <div class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded mt-1">Cierra tras 1ª correcta</div>
        {% endif %}
        {% if q.close_triggered %}
          <div class="inline-block bg-gray-200 text-gray-800 px-2 py-1 rounded mt-1">Cerrada (1ª correcta recibida)</div>
        {% endif %}
        {% if q.qtype == 'multiple_choice' %}
          {% if q.allow_multiple_answers %}
            <div class="inline-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded mt-1">Múltiple selección</div>
          {% endif %}
        {% endif %}
        {% if q.allow_multiple_submissions %}
          <div class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mt-1">Varios envíos</div>
        {% endif %}
        {% if q.start_at %}
          <div>Desde: {{ q.start_at|date:"Y-m-d H:i" }}</div>
        {% endif %}
        {% if q.end_at %}
          <div>Hasta: {{ q.end_at|date:"Y-m-d H:i" }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if selected_room.teacher_id == teacher.id and q.qtype != 'essay' and q.qtype != 'poll' %}
    <div class="px-2 mt-2">
      <button type="button" onclick="event.stopPropagation();" class="px-2 py-1 text-sm bg-indigo-500 text-white rounded toggle-reveal-btn" data-qid="{{ q.id }}">Mostrar respuestas correctas</button>
    </div>
  {% endif %}

  {% if opts %}
    <div class="mt-3">
      {% if q.qtype == 'short_answer' or q.qtype == 'numeric' %}
        {% for o in opts %}{% if o.option_key == 'ANSWER' %}
          <div class="expected-answer text-sm text-gray-700" style="display:none; white-space:pre;">    Respuesta esperada: {{ o.text }}</div>
        {% endif %}{% endfor %}
      {% else %}
        <ul class="list-disc ml-5 text-sm text-gray-700">
          {% for o in opts %}
            <li class="space-x-2">
              <span class="flex-1">{{ o.option_key }}. {{ o.text }}</span>
              {% if o.is_correct %}
                <span class="correct-indicator inline-block text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded" style="display:none">✅ Correcta</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  {% endif %}

  {% if selected_room.teacher_id == teacher.id %}
    <div class="mt-3 flex justify-between items-center">
      <form method="post" action="{% url 'dashboard:toggle_question_active' q.id %}" onclick="event.stopPropagation();">
        {% csrf_token %}
        {% if q.close_on_first_correct and q.close_triggered %}
          <div class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm">Cerrada tras 1ª correcta — no se puede reabrir</div>
        {% else %}
          {% if not q.start_at and not q.end_at %}
            {% if q.manual_active %}
              <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Desactivar</button>
            {% else %}
              <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">Activar</button>
            {% endif %}
          {% else %}
            {% if active_now %}
              {% if not within_window and q.end_at %}
                <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Desactivar (fuera de horario)</button>
              {% else %}
                <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Finalizar ahora</button>
              {% endif %}
            {% else %}
              {% if before_start %}
                <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">Iniciar ahora</button>
              {% elif after_end %}
                <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">Activar (fuera de horario)</button>
              {% else %}
                <button type="submit" class="px-3 py-1 bg-green-600 text-white rounded">Activar</button>
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}
      </form>

      <button 
        type="button" 
        @click.stop="$store.modal.deleteQuestionId = {{ q.id }}; $store.modal.deleteQuestionTitle = '{{ q.title|escapejs }}'; $store.modal.deleteQuestionModal = true"
        class="px-3 py-1 bg-gray-600 text-white rounded"
      >
        Eliminar
      </button>
    </div>
  {% endif %}

  {% include 'dashboard/partials/question_responses.html' %}
</li>
