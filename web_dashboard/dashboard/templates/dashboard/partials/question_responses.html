<div x-show="open" x-transition class="mt-3 ml-2 bg-gray-50 rounded-lg border p-3">
  <h4 class="font-semibold mb-2 text-gray-700">Respuestas ({{ item.responses|length }})</h4>
  {% if item.responses %}
    <ul class="divide-y text-sm text-gray-700">
      {% for r in item.responses %}
        <li class="py-2">
          <div class="flex items-start gap-3">
            <!-- Grade / score badge on the left -->
            <div class="w-20 flex-shrink-0">
              {% if r.score is not None %}
                {% if r.score == 100 %}
                  <div class="text-center text-xs font-semibold px-2 py-1 rounded bg-blue-100 text-blue-800">{{ r.score }}</div>
                {% elif r.score >= 75 %}
                  <div class="text-center text-xs font-semibold px-2 py-1 rounded bg-green-100 text-green-800">{{ r.score }}</div>
                {% elif r.score >= 50 %}
                  <div class="text-center text-xs font-semibold px-2 py-1 rounded bg-yellow-100 text-yellow-800">{{ r.score }}</div>
                {% else %}
                  <div class="text-center text-xs font-semibold px-2 py-1 rounded bg-red-100 text-red-800">{{ r.score }}</div>
                {% endif %}
              {% else %}
                <div class="text-center text-xs font-medium px-2 py-1 rounded bg-gray-100 text-gray-600">Sin nota</div>
              {% endif %}
            </div>

            <!-- Main answer content -->
            <div class="flex-1">
              <div class="flex justify-between items-start">
                <div>
                  <div class="font-medium">
                    {% comment %} prefer Moodle full name when available in `students` list {% endcomment %}
                    {% if r.student %}
                      {% with found_name=None %}{% for s in students %}{% if s.moodle_id == r.student.moodle_id %}{% with found_name=s.full_name %}{% endwith %}{% endif %}{% endfor %}
                        {% if found_name %}
                          {{ found_name }}
                        {% else %}
                          {{ r.student.matrix_id }}
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      ID {{ r.student_id }}
                    {% endif %}
                  </div>
                  <div class="text-xs text-gray-500">{{ r.submitted_at|date:"Y-m-d H:i" }}</div>
                </div>
              </div>

              <div class="mt-1 text-gray-700">
                {% if r.answer_text %}
                  <div class="mb-1">{{ r.answer_text }}</div>
                {% endif %}

                {% if r.option_id %}
                  <div class="text-xs text-gray-600">Opción seleccionada: <strong>{{ r.option_key }}</strong>
                    {% for o in opts %}{% if o.id == r.option_id %}
                      <span class="ml-2 text-sm text-gray-700">— {{ o.text }}</span>
                      {% if o.is_correct %}
                        <span class="response-correct ml-2 text-xs text-green-700" style="display:none">(Correcta)</span>
                      {% else %}
                        <span class="response-incorrect ml-2 text-xs text-red-700" style="display:none">(Incorrecta)</span>
                      {% endif %}
                    {% endif %}{% endfor %}
                  </div>
                {% endif %}

                {% if r.option_ids %}
                  <div class="text-xs text-gray-600">Opciones seleccionadas:</div>
                  <div class="mt-1 flex flex-wrap gap-2">
                    {% for sel_id in r.option_ids %}
                      {% for o in opts %}{% if o.id == sel_id %}
                        <span class="inline-block px-2 py-1 text-xs rounded border {% if o.is_correct %}response-correct text-green-700 border-green-200{% else %}response-incorrect text-red-700 border-red-200{% endif %}" style="display:none">{{ o.option_key }} — {{ o.text }}{% if o.is_correct %} (Correcta){% endif %}</span>
                      {% endif %}{% endfor %}
                    {% endfor %}
                  </div>
                {% endif %}

                {% if q.qtype == 'short_answer' or q.qtype == 'numeric' %}
                  {% if r.answer_text %}
                    <div class="text-xs mt-2">
                      {% for o in opts %}{% if o.option_key == 'ANSWER' %}
                        <div class="expected-answer text-xs text-gray-600" style="display:none">Respuesta esperada: <strong>{{ o.text }}</strong></div>
                        {% if r.answer_text == o.text %}
                          <span class="response-correct ml-2 text-xs text-green-700" style="display:none">(Correcta)</span>
                        {% else %}
                          <span class="response-incorrect ml-2 text-xs text-red-700" style="display:none">(Incorrecta)</span>
                        {% endif %}
                      {% endif %}{% endfor %}
                    </div>
                  {% endif %}
                {% endif %}
              </div>
            </div>

            <!-- Right column: grader, feedback and action -->
            <div class="w-48 flex-shrink-0 text-right">
              <div class="text-xs text-gray-500">
                {% if r.grader %}
                  {% comment %} try to find grader full name in `students` list by moodle_id if available {% endcomment %}
                  {% with gname=None %}{% for s in students %}{% if s.moodle_id == r.grader.moodle_id %}{% with gname=s.full_name %}{% endwith %}{% endif %}{% endfor %}
                    {% if gname %}
                      Corregido por: {{ gname }}
                    {% else %}
                      Corregido por: {{ r.grader.matrix_id }}
                    {% endif %}
                  {% endwith %}
                {% else %}
                  Corregido por: Automático
                {% endif %}
              </div>
              {% if r.feedback %}
                <div class="mt-2 text-sm text-gray-700 bg-gray-50 p-2 rounded">Feedback: {{ r.feedback }}</div>
              {% endif %}
              <div class="mt-3">
                <button type="button" onclick="event.stopPropagation();" class="px-2 py-1 bg-indigo-500 text-white rounded text-sm open-grade-modal" data-response-id="{{ r.id }}" data-score="{{ r.score|default_if_none:'' }}" data-feedback="{{ r.feedback|default_if_none:''|escapejs }}">Corregir</button>
              </div>
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-gray-500 italic">Aún no hay respuestas.</p>
  {% endif %}
</div>
