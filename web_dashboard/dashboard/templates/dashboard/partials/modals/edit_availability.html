<div 
  x-show="$store.modal.editAvailabilityModal" 
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  x-transition.opacity
  x-data="{}"
  @keydown.escape.window="$store.modal.editAvailabilityModal = false"
  @click.self="$store.modal.editAvailabilityModal = false"
>
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 relative" @click.stop x-transition.opacity>
    <h3 class="text-lg font-semibold mb-4">Editar intervalo de disponibilidad</h3>

    {% if edit_availability_form and edit_availability_form.non_field_errors %}
      <div class="mb-4 p-2 bg-red-100 text-red-700 rounded">
        {% for error in edit_availability_form.non_field_errors %}
          <p>{{ error }}</p>
        {% endfor %}
      </div>
    {% endif %}

  <form id="edit_availability_form" method="POST" action="{% url 'edit_availability' %}">
      {% csrf_token %}
      <input type="hidden" name="avail_id" id="edit_avail_id" value="{{ edit_availability_id|default:'' }}">

      <div class="mb-3">
        <label class="block mb-1 font-medium">Inicio</label>
        <input type="time" id="edit_start_time" name="start_time" class="w-full border rounded px-3 py-2" value="{% if edit_availability_form %}{{ edit_availability_form.start_time.value|default_if_none:'' }}{% endif %}" required>
        {% if edit_availability_form and edit_availability_form.start_time.errors %}
          <p class="text-red-600 text-sm mt-1">{{ edit_availability_form.start_time.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="mb-3">
        <label class="block mb-1 font-medium">Fin</label>
        <input type="time" id="edit_end_time" name="end_time" class="w-full border rounded px-3 py-2" value="{% if edit_availability_form %}{{ edit_availability_form.end_time.value|default_if_none:'' }}{% endif %}" required>
        {% if edit_availability_form and edit_availability_form.end_time.errors %}
          <p class="text-red-600 text-sm mt-1">{{ edit_availability_form.end_time.errors.0 }}</p>
        {% endif %}
      </div>

      <p class="text-sm text-gray-600 mb-3">Horario permitido: <strong>07:00</strong> — <strong>21:00</strong></p>
      <p id="edit_time_error" class="text-red-600 text-sm mb-3 hidden"></p>

      <div class="flex justify-end space-x-2">
        <button type="button" @click="$store.modal.editAvailabilityModal = false" class="px-4 py-2 border rounded hover:bg-gray-100">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // helper to open edit modal from slot element/button
  function openEditModalFromSlot(el) {
    try {
      if (typeof Alpine === 'undefined') return;
      var slotEl = el.closest('[data-id]') || el;
      if (!slotEl) return;
      var id = slotEl.getAttribute('data-id');
      var start = slotEl.getAttribute('data-start') || slotEl.getAttribute('data-label')?.split(' — ')[0] || '';
      var end = slotEl.getAttribute('data-end') || slotEl.getAttribute('data-label')?.split(' — ')[1] || '';

      // set hidden inputs if present
      var hid = document.getElementById('edit_avail_id');
      var st = document.getElementById('edit_start_time');
      var et = document.getElementById('edit_end_time');
      if (hid) hid.value = id || '';
      if (st) st.value = start || '';
      if (et) et.value = end || '';

      Alpine.store('modal').editAvailabilityId = id;
      Alpine.store('modal').editAvailabilityStart = start;
      Alpine.store('modal').editAvailabilityEnd = end;
      Alpine.store('modal').editAvailabilityModal = true;
    } catch (e) {
      console.error('openEditModalFromSlot error', e);
    }
  }
</script>

<script>
  (function(){
    const MIN = '07:00';
    const MAX = '21:00';
  const form = document.getElementById('edit_availability_form');
    const st = document.getElementById('edit_start_time');
    const et = document.getElementById('edit_end_time');
    const err = document.getElementById('edit_time_error');

    function showError(msg){
      if (!err) return;
      err.textContent = msg;
      err.classList.remove('hidden');
    }
    function hideError(){ if (err) { err.textContent=''; err.classList.add('hidden'); } }

    if (!form) return;
    form.addEventListener('submit', function(ev){
      hideError();
      const s = st && st.value ? st.value : '';
      const e = et && et.value ? et.value : '';
      if (!s || !e){ showError('Por favor, indique hora de inicio y fin.'); ev.preventDefault(); return; }
      if (s >= e){ showError('La hora de inicio debe ser anterior a la hora de fin.'); ev.preventDefault(); return; }
      if (s < MIN || e > MAX){ showError(`Los intervalos deben estar dentro de ${MIN} — ${MAX}.`); ev.preventDefault(); return; }
    });
  })();
</script>
