<div 
  x-show="$store.modal.createQuestionModal" 
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  x-transition.opacity
  x-data="{
    qtype: '{{ create_question_form.qtype.value|default:'multiple_choice' }}',
    options: JSON.parse('{{ create_question_options_json|default:'[]'|escapejs }}')
  }"
  @keydown.escape.window="$store.modal.createQuestionModal = false"
  @click.self="$store.modal.createQuestionModal = false"
>
  <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-2xl p-6 relative" @click.stop x-transition.opacity>
    <h3 class="text-lg font-semibold mb-4">Crear nueva pregunta</h3>

    {% if create_question_form and create_question_form.non_field_errors %}
      <div class="mb-4 p-2 bg-red-100 text-red-700 rounded">
        {% for error in create_question_form.non_field_errors %}
          <p>{{ error }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <form method="POST" action="{% url 'create_question' %}">
      {% csrf_token %}
      <input type="hidden" name="selected_room_id" value="{{ selected_room.id|default:'' }}">

      <div class="mb-3">
        <label class="block mb-1 font-medium">Título (opcional)</label>
        <input type="text" name="title" class="w-full border rounded px-3 py-2" value="{{ create_question_form.title.value|default_if_none:'' }}">
      </div>

      <div class="mb-3">
        <label class="block mb-1 font-medium">Enunciado</label>
        <textarea name="body" required class="w-full border rounded px-3 py-2" rows="3">{{ create_question_form.body.value|default_if_none:'' }}</textarea>
      </div>

      <div class="mb-3">
        <label class="block mb-1 font-medium">Tipo de pregunta</label>
        <select name="qtype" x-model="qtype" class="w-full border rounded px-3 py-2">
          <option value="multiple_choice" {% if create_question_form and create_question_form.qtype.value == 'multiple_choice' %}selected{% endif %}>Opción múltiple</option>
          <option value="true_false" {% if create_question_form and create_question_form.qtype.value == 'true_false' %}selected{% endif %}>Verdadero/Falso</option>
          <option value="short_answer" {% if create_question_form and create_question_form.qtype.value == 'short_answer' %}selected{% endif %}>Respuesta corta</option>
          <option value="numeric" {% if create_question_form and create_question_form.qtype.value == 'numeric' %}selected{% endif %}>Numérica</option>
          <option value="essay" {% if create_question_form and create_question_form.qtype.value == 'essay' %}selected{% endif %}>Desarrollo</option>
        </select>
      </div>

      <template x-if="qtype == 'multiple_choice' || qtype == 'true_false'">
        <div class="mb-3" x-data="{ opts: options }">
          <label class="block mb-1 font-medium">Opciones</label>
          <template x-for="(opt, idx) in opts" :key="idx">
            <div class="flex items-center space-x-2 mb-2">
              <input :name="`option_${idx}`" x-model="opts[idx]" class="flex-1 border rounded px-3 py-2" placeholder="Texto de la opción">
              <button type="button" @click="opts.splice(idx,1)" class="px-2 py-1 bg-red-600 text-white rounded">Eliminar</button>
            </div>
          </template>

          <div class="flex space-x-2">
            <button type="button" @click="opts.push('')" class="px-3 py-1 bg-blue-600 text-white rounded">Añadir opción</button>
            <div class="text-sm text-gray-500 self-center">Añade opciones y, después de crear, marca la(s) correcta(s) desde la edición.</div>
          </div>
          <template x-for="(opt, idx) in opts" :key="'hidden-'+idx">
            <input type="hidden" :name="`option_${idx}`" :value="opt">
          </template>
        </div>
      </template>

      <div class="mb-3 grid grid-cols-2 gap-3">
        <div>
          <label class="block mb-1 font-medium">Inicio</label>
          <input type="datetime-local" name="start_at" class="w-full border rounded px-3 py-2" value="{{ create_question_form.start_at.value|default_if_none:'' }}">
        </div>
        <div>
          <label class="block mb-1 font-medium">Fin</label>
          <input type="datetime-local" name="end_at" class="w-full border rounded px-3 py-2" value="{{ create_question_form.end_at.value|default_if_none:'' }}">
        </div>
      </div>

      <div class="mb-4 space-y-2">
        <label class="flex items-center space-x-2"><input type="checkbox" name="allow_multiple_answers" class="rounded" {% if create_question_form.allow_multiple_answers.value %}checked{% endif %}> Permitir varias respuestas</label>
        <label class="flex items-center space-x-2"><input type="checkbox" name="allow_multiple_submissions" class="rounded" {% if create_question_form.allow_multiple_submissions.value %}checked{% endif %}> Permitir varios envíos por alumno</label>
      </div>

      <div class="flex justify-end space-x-2">
        <button type="button" @click="$store.modal.createQuestionModal = false" class="px-4 py-2 border rounded hover:bg-gray-100">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Crear pregunta</button>
      </div>
    </form>
  </div>
</div>
